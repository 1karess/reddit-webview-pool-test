<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>iframeå†…å®¹ï¼ˆpostMessageæµ‹è¯•ï¼‰</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #e8f4f8;
        }
        .info {
            background: white;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .received-data {
            background: #fff9e6;
            padding: 15px;
            border-left: 4px solid #ff9800;
            margin: 10px 0;
        }
        .warning {
            background: #fff5f5;
            border-left-color: #ff4500;
        }
    </style>
</head>
<body>
    <h3>ğŸ–¼ï¸ ç¬¬ä¸‰æ–¹iframeï¼ˆæ¨¡æ‹Ÿç¬¬ä¸‰æ–¹æœåŠ¡ï¼‰</h3>
    <div class="info">
        <p><strong>å½“å‰originï¼š</strong><span id="origin"></span></p>
        <p><strong>çŠ¶æ€ï¼š</strong>ç­‰å¾…æ¥æ”¶postMessageæ•°æ®...</p>
    </div>

    <div id="receivedData" class="received-data" style="display: none;">
        <h4>ğŸ“¨ æ”¶åˆ°çš„æ•°æ®ï¼š</h4>
        <pre id="dataContent"></pre>
    </div>

    <div id="history" class="info">
        <h4>ğŸ“œ æ¥æ”¶å†å²ï¼š</h4>
        <div id="historyContent">ï¼ˆæ— ï¼‰</div>
    </div>

    <script>
        // æ˜¾ç¤ºå½“å‰origin
        document.getElementById('origin').textContent = window.location.origin;

        let receivedMessages = [];

        // ç›‘å¬çˆ¶é¡µé¢çš„postMessage
        window.addEventListener('message', function(event) {
            // éªŒè¯æ¥æºï¼ˆå®é™…åº”ç”¨ä¸­åº”è¯¥éªŒè¯event.originï¼‰
            if (event.data && event.data.type === 'userData') {
                const userData = event.data.data;
                receivedMessages.push({
                    timestamp: new Date().toISOString(),
                    data: userData
                });

                // æ˜¾ç¤ºæ”¶åˆ°çš„æ•°æ®
                document.getElementById('receivedData').style.display = 'block';
                document.getElementById('dataContent').textContent = 
                    JSON.stringify(userData, null, 2);

                // æ£€æŸ¥æ˜¯å¦æœ‰è­¦å‘Š
                if (userData.warning) {
                    document.getElementById('receivedData').className = 'received-data warning';
                    document.getElementById('dataContent').textContent += '\n\n' + userData.warning;
                } else {
                    document.getElementById('receivedData').className = 'received-data';
                }

                // æ›´æ–°å†å²
                updateHistory();

                // å‘é€ç¡®è®¤ç»™çˆ¶é¡µé¢
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'dataReceived',
                        data: userData,
                        timestamp: new Date().toISOString()
                    }, '*');
                }

                // âš ï¸ æ¨¡æ‹Ÿç¬¬ä¸‰æ–¹æœåŠ¡ä½¿ç”¨æ”¶åˆ°çš„tokenå‘èµ·è¯·æ±‚
                if (userData.token) {
                    console.log('âš ï¸ æ¨¡æ‹Ÿï¼šç¬¬ä¸‰æ–¹æœåŠ¡ä½¿ç”¨tokenå‘èµ·è¯·æ±‚:', userData.token);
                    // å®é™…åœºæ™¯ä¸­ï¼Œè¿™é‡Œå¯èƒ½ä¼šï¼š
                    // fetch('/api/user', {
                    //     headers: {
                    //         'Authorization': 'Bearer ' + userData.token
                    //     }
                    // });
                }
            } else if (event.data && event.data.action === 'clear') {
                receivedMessages = [];
                document.getElementById('receivedData').style.display = 'none';
                updateHistory();
            }
        });

        // æ›´æ–°å†å²
        function updateHistory() {
            const historyContent = document.getElementById('historyContent');
            if (receivedMessages.length === 0) {
                historyContent.textContent = 'ï¼ˆæ— ï¼‰';
            } else {
                historyContent.innerHTML = receivedMessages.map((msg, index) => {
                    const data = msg.data;
                    let html = `<div style="margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 4px;">`;
                    html += `<strong>æ¶ˆæ¯ #${index + 1}</strong> (${msg.timestamp})<br>`;
                    html += `userId: ${data.userId || 'N/A'}<br>`;
                    html += `account: ${data.account || 'N/A'}<br>`;
                    if (data.warning) {
                        html += `<span style="color: #ff4500;">${data.warning}</span>`;
                    }
                    html += `</div>`;
                    return html;
                }).join('');
            }
        }
    </script>
</body>
</html>
