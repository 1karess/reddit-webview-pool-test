<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>iframeå†…å®¹ï¼ˆCookieæµ‹è¯•ï¼‰</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #e8f4f8;
        }
        .info {
            background: white;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h3>ğŸ–¼ï¸ è¿™æ˜¯åŒæºiframe</h3>
    <div class="info">
        <p><strong>å½“å‰originï¼š</strong><span id="origin"></span></p>
        <p><strong>Cookieï¼š</strong></p>
        <pre id="cookieData">ï¼ˆç©ºï¼‰</pre>
    </div>

    <script>
        // æ˜¾ç¤ºå½“å‰origin
        document.getElementById('origin').textContent = window.location.origin;

        // è¯»å–Cookie
        function readCookie() {
            const cookies = document.cookie || '';
            const cookieObj = {};
            
            if (cookies.trim() !== '') {
                cookies.split(';').forEach(cookie => {
                    const parts = cookie.trim().split('=');
                    if (parts.length >= 2) {
                        cookieObj[parts[0]] = parts.slice(1).join('=');
                    }
                });
            }
            
            const result = Object.keys(cookieObj).length > 0 
                ? JSON.stringify(cookieObj, null, 2)
                : 'ï¼ˆç©ºï¼‰';
            
            document.getElementById('cookieData').textContent = result;
            
            // å‘é€ç»™çˆ¶é¡µé¢
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'cookieData',
                    cookies: cookies,
                    cookieObj: cookieObj
                }, '*');
            }
        }

        // å‘é€è¯·æ±‚ï¼ˆè‡ªåŠ¨æºå¸¦Cookieï¼‰
        function sendRequest() {
            // æ¨¡æ‹Ÿå‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨
            // å®é™…åœºæ™¯ä¸­ï¼Œè¿™é‡Œä¼šå‘é€çœŸå®çš„HTTPè¯·æ±‚
            const cookies = document.cookie || '';
            const cookieObj = {};
            
            if (cookies.trim() !== '') {
                cookies.split(';').forEach(cookie => {
                    const parts = cookie.trim().split('=');
                    if (parts.length >= 2) {
                        cookieObj[parts[0]] = parts.slice(1).join('=');
                    }
                });
            }
            
            // æ¨¡æ‹Ÿè¯·æ±‚ç»“æœ
            const result = {
                url: '/api/user',
                method: 'GET',
                cookies: cookieObj,
                timestamp: new Date().toISOString()
            };
            
            // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†è´¦å·Açš„Cookie
            if (cookieObj.session_id && cookieObj.session_id.includes('account_A')) {
                result.warning = 'âš ï¸ è­¦å‘Šï¼šiframeä½¿ç”¨äº†è´¦å·Açš„Cookieå‘é€è¯·æ±‚ï¼';
                result.risk = 'æœåŠ¡å™¨å¯èƒ½è¯¯è®¤ä¸ºæ˜¯è´¦å·Açš„è¯·æ±‚ï¼Œå¯¼è‡´æƒé™æ··ä¹±æˆ–è¶Šæƒè®¿é—®ï¼';
            }
            
            // å®é™…åœºæ™¯ä¸­ï¼Œè¿™é‡Œä¼šæ‰§è¡Œï¼š
            // fetch('/api/user', {
            //     credentials: 'include'  // è‡ªåŠ¨æºå¸¦Cookie
            // }).then(response => {
            //     // å¤„ç†å“åº”
            // });
            
            // å‘é€ç»“æœç»™çˆ¶é¡µé¢
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'requestResult',
                    result: result
                }, '*');
            }
        }

        // æ¸…ç©ºCookie
        function clearCookie() {
            document.cookie.split(";").forEach(function(c) { 
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
            });
            readCookie();
        }

        // ç›‘å¬çˆ¶é¡µé¢çš„æ¶ˆæ¯
        window.addEventListener('message', function(event) {
            if (event.data && event.data.action === 'readCookie') {
                readCookie();
            } else if (event.data && event.data.action === 'sendRequest') {
                sendRequest();
            } else if (event.data && event.data.action === 'clearCookie') {
                clearCookie();
            }
        });

        // è‡ªåŠ¨è¯»å–
        readCookie();
        
        // å®šæœŸæ›´æ–°ï¼ˆæ¯2ç§’ï¼‰
        setInterval(readCookie, 2000);
    </script>
</body>
</html>
