# Reddit WebView Pool 实际隐私泄露分析

## 核心问题

**即使知道 WebView Pool 不清空存储，到底能读取到什么用户隐私？能造成什么实际危害？**

---

## 1. window.name 中的 bridgeContext

### 代码证据

**文件**: `l.java:123`
```java
window.name = JSONObject.quote(bridgeContext);
```

**文件**: `d.java:361`
```java
window.name = JSONObject.quote(strA);  // strA 就是 bridgeContext
```

### bridgeContext 是什么？

**文件**: `sources/com/reddit/devvit/ui/effects/web_view/v1alpha/Context$BridgeContext.java`

**bridgeContext 包含的字段**（从源代码分析）：
- `webbitToken_` (String) - **可能包含认证 token**
- `signedRequestContext_` (String) - **可能包含签名请求上下文**
- `postData_` (DevvitPostData) - 帖子数据
- `shareParam_` - 分享参数
- `webViewContext_` - WebView 上下文
- `webViewClientData_` (Struct) - WebView 客户端数据
- `appPermissionState_` - 应用权限状态
- `client_` (int) - 客户端类型
- `viewMode_` (int) - 视图模式

**潜在敏感字段**：
- ⚠️ **`webbitToken`** - 可能是认证 token
- ⚠️ **`signedRequestContext`** - 可能包含签名/会话信息
- ⚠️ **`postData`** - 可能包含用户创建的帖子数据
- ⚠️ **`webViewClientData`** - 可能包含客户端状态数据

### window.name 的特性

- ✅ **持久化**：在 WebView 中，`window.name` 会持久化，即使页面关闭
- ✅ **跨页面**：同一个 WebView 实例加载不同页面时，`window.name` 保持不变
- ⚠️ **如果 bridgeContext 包含用户 ID、token 等信息，会跨账号残留**

---

## 2. 文件上传持久攻击？

### 问题分析

**能否通过文件上传进行持久攻击？**

#### WebView 文件访问权限

需要检查：
- WebView 是否实现了 `WebChromeClient.onShowFileChooser()`
- 文件访问权限如何控制
- 上传的文件是否会被持久化到 WebView 可访问的位置

#### 可能的攻击场景

1. **文件上传到 WebView 可访问的目录**
   - 如果上传的文件保存到 `/data/data/com.reddit.frontpage/app_webview/` 下
   - 后续账号可能通过 `file://` 协议访问

2. **通过 IndexedDB 存储文件**
   - 如果 WebView 支持 File API
   - 恶意页面可能把文件内容存到 IndexedDB
   - 后续账号可能读取

3. **通过 localStorage 存储文件内容（Base64）**
   - 虽然有限制，但小文件可能可以

**需要验证**：Reddit 的 WebView 是否实现了文件上传功能，以及文件存储位置。

---

## 3. 实际能泄露的隐私

### 场景 1：window.name 泄露

**如果 bridgeContext 包含**：
- 用户 ID
- Session token
- 用户设置
- 其他用户相关信息

**攻击方式**：
1. 账号 A 打开 DevPlatform 页面，`window.name` 被设置为包含账号 A 信息的 bridgeContext
2. 账号 A 退出，账号 B 登录
3. 账号 B 打开同一个 DevPlatform 页面（复用同一个 WebView）
4. 恶意 JavaScript 读取 `window.name`，获取账号 A 的信息

**验证方法**：
- 在测试页面中读取 `window.name`
- 看是否包含用户相关信息

---

### 场景 2：第三方页面存储的数据

**如果第三方 DevPlatform 页面在 localStorage 中存储**：
- 用户 ID
- 访问历史
- 用户偏好
- 其他业务数据

**攻击方式**：
1. 账号 A 访问第三方页面，页面在 localStorage 中存储账号 A 的数据
2. 账号 A 退出，账号 B 登录
3. 账号 B 访问同一个第三方页面（复用同一个 WebView）
4. 页面读取 localStorage，获取账号 A 的数据

**验证方法**：
- 在真实 DevPlatform 页面中检测 localStorage
- 看是否有用户相关数据

---

### 场景 3：Cookie 泄露（非 HttpOnly）

**如果页面设置了非 HttpOnly Cookie**：
- 用户标识
- 会话信息
- 其他敏感数据

**攻击方式**：
1. 账号 A 访问页面，页面设置 Cookie
2. 账号 A 退出，账号 B 登录
3. 账号 B 访问同一个页面，读取 Cookie

**验证方法**：
- 在测试页面中读取 `document.cookie`
- 看是否有非 HttpOnly Cookie

---

### 场景 4：IndexedDB 泄露

**如果页面在 IndexedDB 中存储数据**：
- 用户数据
- 缓存内容
- 其他持久化数据

**攻击方式**：
1. 账号 A 访问页面，页面在 IndexedDB 中存储数据
2. 账号 A 退出，账号 B 登录
3. 账号 B 访问同一个页面，读取 IndexedDB

**验证方法**：
- 在测试页面中检测 IndexedDB
- 看是否有数据

---

## 4. 需要验证的具体问题

### 问题 1：bridgeContext 到底包含什么？

**验证方法**：
1. 在测试页面中读取 `window.name`
2. 解析 JSON，看包含什么字段
3. 检查是否有用户 ID、token 等敏感信息

### 问题 2：能否通过文件上传进行持久攻击？

**验证方法**：
1. 检查 WebView 是否实现了文件上传功能
2. 如果实现了，测试上传的文件是否会被后续账号访问到

### 问题 3：真实 DevPlatform 页面存储了什么？

**验证方法**：
1. 在真实 DevPlatform 页面中执行检测脚本
2. 查看 localStorage、sessionStorage、Cookie、IndexedDB
3. 看是否有用户相关数据

---

## 5. 实际测试建议

### 测试 1：检测 window.name

在测试页面中添加：
```javascript
console.log('window.name:', window.name);
// 如果 window.name 包含 JSON，解析它
try {
  const bridgeContext = JSON.parse(window.name);
  console.log('bridgeContext:', bridgeContext);
} catch(e) {
  console.log('window.name is not JSON:', window.name);
}
```

### 测试 2：检测真实 DevPlatform 页面

1. 找到真实的 DevPlatform 页面
2. 在页面中执行检测脚本
3. 查看所有存储的数据

### 测试 3：文件上传测试

1. 创建一个测试页面，尝试上传文件
2. 检查文件是否被保存
3. 切换账号后，检查是否能访问上传的文件

---

## 6. 结论

### 目前已知

1. ✅ WebView Pool 不清空存储（代码证据）
2. ✅ Reddit 代码中没有操作 localStorage（搜索证据）
3. ⚠️ window.name 可能包含 bridgeContext（代码证据，但内容未知）
4. ❓ 实际能泄露什么隐私（需要测试验证）

### 需要验证

1. **bridgeContext 的内容**：是否包含用户敏感信息？
2. **文件上传能力**：能否进行持久攻击？
3. **真实页面存储**：DevPlatform 页面到底存了什么？

### 下一步

1. 在测试页面中添加 `window.name` 检测
2. 在真实 DevPlatform 页面中执行检测
3. 根据实际测试结果，确定实际风险等级
