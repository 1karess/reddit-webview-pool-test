# Reddit WebView Pool 风险测试 - 详细步骤（小白版）

## 📋 准备工作清单

- [ ] Mac 电脑（已准备好）
- [ ] 安卓手机（已准备好）
- [ ] USB 数据线
- [ ] 手机已开启“开发者选项”和“USB 调试”
- [ ] 手机已安装 Reddit App
- [ ] 准备两个 Reddit 测试账号（账号A 和 账号B）

---

## 第一部分：Mac 环境搭建

### 步骤 1：打开终端（Terminal）

1. 按 `Command + 空格键` 打开 Spotlight
2. 输入 `Terminal` 或 `终端`
3. 回车打开

### 步骤 2：检查 Python3

在终端输入：
```bash
python3 --version
```

**预期结果**：显示类似 `Python 3.9.6` 的版本号

**如果没有 Python3**：
- 访问 https://www.python.org/downloads/
- 下载并安装最新版 Python3

### 步骤 3：安装 Frida

在终端输入：
```bash
pip3 install frida-tools
```

**如果提示权限错误**，用这个：
```bash
pip3 install --user frida-tools
```

**等待安装完成**（可能需要 1-2 分钟）

### 步骤 4：验证 Frida 安装

```bash
frida --version
```

**预期结果**：显示版本号，如 `16.2.1`

---

## 第二部分：手机环境搭建

### 步骤 5：开启开发者选项（如果还没开启）

1. 打开手机“设置”
2. 找到“关于手机”（可能在“系统”或“我的设备”里）
3. 连续点击“版本号”7次
4. 会提示“您已成为开发者”

### 步骤 6：开启 USB 调试

1. 回到“设置”
2. 找到“开发者选项”（通常在“系统”或“其他设置”里）
3. 开启“USB 调试”
4. 开启“USB 安装”（如果有）

### 步骤 7：连接手机到 Mac

1. 用 USB 数据线连接手机和 Mac
2. 手机上会弹出“允许 USB 调试？”的提示
3. **勾选“始终允许这台计算机”**
4. 点击“确定”

### 步骤 8：检查 adb 连接

在 Mac 终端输入：
```bash
adb devices
```

**预期结果**：
```
List of devices attached
xxxxx    device
```

**如果显示 `unauthorized`**：
- 在手机上再次点击“允许 USB 调试”

**如果没有 `adb` 命令**：
- 需要安装 Android SDK Platform Tools
- 访问：https://developer.android.com/studio/releases/platform-tools
- 下载 Mac 版本，解压后把 `adb` 添加到 PATH

---

## 第三部分：安装 frida-server 到手机

### 步骤 9：查看手机架构

在终端输入：
```bash
adb shell getprop ro.product.cpu.abi
```

**常见结果**：
- `arm64-v8a` → 最常见，64位 ARM
- `armeabi-v7a` → 32位 ARM
- `x86_64` → 64位 x86（模拟器）

**记下这个结果**，下一步要用

### 步骤 10：下载 frida-server

1. 访问：https://github.com/frida/frida/releases
2. 找到最新的稳定版本（如 `frida-16.2.1`）
3. 根据你的架构下载对应的文件：
   - `arm64-v8a` → 下载 `frida-server-16.2.1-android-arm64.xz`
   - `armeabi-v7a` → 下载 `frida-server-16.2.1-android-arm.xz`
   - `x86_64` → 下载 `frida-server-16.2.1-android-x86_64.xz`

### 步骤 11：解压并推送文件

假设你下载的是 `frida-server-16.2.1-android-arm64.xz`：

```bash
# 进入下载目录
cd ~/Downloads

# 解压文件
unxz frida-server-16.2.1-android-arm64.xz

# 推送到手机
adb push frida-server-16.2.1-android-arm64 /data/local/tmp/frida-server

# 给执行权限
adb shell "chmod 755 /data/local/tmp/frida-server"
```

**如果 `unxz` 命令不存在**：
- 可以用解压软件手动解压，然后推送 `.xz` 解压后的文件

### 步骤 12：启动 frida-server

```bash
adb shell "/data/local/tmp/frida-server &"
```

**预期结果**：命令立即返回，没有错误

**验证是否运行**：
```bash
adb shell "ps | grep frida"
```

应该看到 `frida-server` 进程

---

## 第四部分：测试连接

### 步骤 13：测试 Frida 连接

```bash
frida-ps -U
```

**预期结果**：显示手机上的进程列表（很多行）

**如果报错 `unable to connect`**：
1. 检查 frida-server 是否运行：`adb shell "ps | grep frida"`
2. 如果没有，重新运行：`adb shell "/data/local/tmp/frida-server &"`

### 步骤 14：查找 Reddit App 包名

```bash
frida-ps -Uai | grep -i reddit
```

**预期结果**：
```
12345  com.reddit.frontpage  Reddit
```

**记下包名**（如 `com.reddit.frontpage`），后面要用

---

## 第五部分：准备测试脚本

### 步骤 15：确认脚本文件位置

在终端输入：
```bash
cd ~/Desktop/reddit-code
ls -la webview_test.js
```

**应该看到**：`webview_test.js` 文件存在

**如果不存在**：
- 检查文件是否在正确位置
- 或者重新创建文件

---

## 第六部分：运行测试

### 步骤 16：启动 Reddit App（手动）

1. 在手机上打开 Reddit App
2. 登录**账号A**
3. 让 App 保持运行状态

### 步骤 17：附加 Frida 脚本

在 Mac 终端输入（把 `<包名>` 替换成你找到的包名）：
```bash
frida -U <包名> -l webview_test.js
```

**例如**：
```bash
frida -U com.reddit.frontpage -l webview_test.js
```

**预期结果**：
- 终端开始显示日志
- 看到类似 `[2024-01-01T12:00:00.000Z] WebView Pool 风险检测脚本已加载`

**如果报错 `unable to attach`**：
- 尝试先关闭 App，然后用 `-f` 参数启动：
```bash
frida -U -f com.reddit.frontpage -l webview_test.js --no-pause
```

### 步骤 18：在 App 中触发 WebView

1. 在 Reddit App 中找到能打开 WebView 的内容
   - 可能是某个帖子里的链接
   - 可能是设置里的某个页面
   - 可能是 DevPlatform 相关的内容
2. 点击打开

**观察终端输出**：
- 应该看到 `[loadUrl]` 或 `[loadDataWithBaseURL]` 的日志
- 应该看到 `[onPageFinished]` 的日志
- 应该看到 `WebStorage 数据` 的输出

### 步骤 19：测试账号切换场景

1. **在账号A下**：
   - 打开一个 WebView 页面
   - 如果页面支持，尝试写入一些数据到 localStorage
   - 关闭这个 WebView（返回上一页）

2. **切换到账号B**：
   - 在 Reddit App 中退出账号A
   - 登录账号B

3. **再次打开 WebView**：
   - 打开同一个或类似的 WebView 页面
   - 观察终端输出

### 步骤 20：分析结果

**查看终端输出，关注以下几点**：

1. **WebView 复用检测**：
   - 如果看到 `[⚠️ 复用检测: 这个 WebView 之前见过!]`
   - 说明同一个 WebView 实例被复用了

2. **WebStorage 数据残留**：
   - 在账号B下打开页面后
   - 查看 `localStorage` 或 `sessionStorage` 的输出
   - 如果还能看到账号A留下的数据，**说明存在风险**

3. **Cookie 残留**：
   - 查看 `Cookie` 字段
   - 如果还能看到账号A的 Cookie，**说明存在风险**

---

## 常见问题排查

### 问题 1：`adb devices` 显示 `unauthorized`

**解决**：
1. 拔掉 USB 线，重新连接
2. 在手机上点击“允许 USB 调试”
3. 勾选“始终允许这台计算机”

### 问题 2：`frida-ps -U` 报错

**解决**：
1. 检查 frida-server：
   ```bash
   adb shell "ps | grep frida"
   ```
2. 如果没有运行，重新启动：
   ```bash
   adb shell "/data/local/tmp/frida-server &"
   ```

### 问题 3：脚本报错找不到类

**解决**：
- 这是正常的！说明类被混淆了
- 脚本会自动 fallback 到通用 hook
- 仍然可以检测 WebView 行为和 WebStorage

### 问题 4：看不到任何日志

**解决**：
1. 确认脚本已加载（应该看到初始化的日志）
2. 确认在 App 中真的打开了 WebView
3. 尝试在 App 中打开不同的页面

### 问题 5：手机重启后无法连接

**解决**：
- 每次重启手机后，需要重新运行：
  ```bash
  adb shell "/data/local/tmp/frida-server &"
  ```

---

## 测试结果判断

### ✅ 低风险（安全）
- WebView 每次都是新创建的（没有复用提示）
- 账号切换后，WebStorage 和 Cookie 都被清空

### ⚠️ 中风险
- WebView 被复用，但账号切换后数据被清空
- 或者 WebView 不被复用，但数据没有完全清空

### ❌ 高风险（存在漏洞）
- WebView 被复用（看到复用提示）
- **并且**账号切换后，WebStorage 或 Cookie 仍保留账号A的数据
- **并且**账号B能访问到这些数据

---

## 下一步

如果检测到高风险，可以：
1. 截图保存终端输出
2. 记录复现步骤
3. 准备报告给 Reddit 安全团队

---

## 需要帮助？

如果遇到问题，请提供：
1. 错误信息（完整复制）
2. 你执行的具体命令
3. 手机型号和 Android 版本

