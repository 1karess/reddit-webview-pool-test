<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LocalStorage Cross-App Test</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        padding: 16px;
        line-height: 1.5;
      }
      .row {
        margin: 10px 0;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      button {
        padding: 10px 14px;
        border: 0;
        border-radius: 10px;
        background: #2d6cdf;
        color: #fff;
        font-weight: 650;
        cursor: pointer;
      }
      button.secondary {
        background: #6c757d;
      }
      #result {
        margin-top: 12px;
        padding: 12px;
        border: 1px solid #e5e5e5;
        border-radius: 10px;
        word-break: break-word;
      }
      code {
        background: #f6f8fa;
        padding: 2px 6px;
        border-radius: 6px;
      }
    </style>
  </head>
  <body>
    <h1>LocalStorage Cross-App Test</h1>
    <p>
      å½“å‰ Origin: <code id="origin"></code><br />
      Key: <code>tracker_id</code>
    </p>
    <p>
      æ¥è‡ªç½‘ç«™Açš„è·³è½¬å‚æ•° tid: <code id="tid">(none)</code>
      <br />
      å·²å½’å› å¹¶ä¿å­˜åˆ°æœ¬åŸŸ last_tid: <code id="lastTid">(none)</code>
      <br />
      <small>è¯´æ˜ï¼šè·¨åŸŸæ—¶ï¼Œç½‘ç«™Bè¯»ä¸åˆ°ç½‘ç«™Açš„ localStorage/cookieï¼›ä½†å¦‚æœ A æŠŠ ID æ”¾è¿› URL å‚æ•°ï¼ˆtidï¼‰ï¼ŒB å¯ä»¥è¯»å–å¹¶ç”¨äºâ€œè·¨åŸŸå…³è”â€ã€‚</small>
    </p>
    <p>
      <button class="secondary" onclick="saveTid()">æ‰‹åŠ¨ä¿å­˜ tid â†’ last_tid</button>
      <button class="secondary" onclick="clearLastTid()">æ¸…é™¤ last_tid</button>
    </p>

    <div class="row">
      <button onclick="writeId()">å†™å…¥ID</button>
      <button class="secondary" onclick="readId()">è¯»å–ID</button>
      <button class="secondary" onclick="clearId()">æ¸…é™¤ID</button>
    </div>

    <div id="result">ç­‰å¾…æ“ä½œâ€¦</div>

    <script>
      document.getElementById("origin").textContent = window.location.origin;
      const tid = new URLSearchParams(window.location.search).get("tid");
      document.getElementById("tid").textContent = tid || "(none)";
      const LAST_TID_KEY = "last_tid";
      const TRACKER_KEY = "tracker_id";

      function refreshLastTid() {
        document.getElementById("lastTid").textContent =
          localStorage.getItem(LAST_TID_KEY) || "(none)";
      }

      // Auto-attribution (real-world pattern):
      // If tid exists, persist it on B (this origin) as the user's attribution ID.
      if (tid) {
        localStorage.setItem(LAST_TID_KEY, tid);
        // Also write to the main tracker key so "è¯»å–ID" can read it.
        localStorage.setItem(TRACKER_KEY, tid);
      }
      refreshLastTid();

      function saveTid() {
        if (!tid) {
          document.getElementById("result").innerHTML = "âŒ å½“å‰ URL æ²¡æœ‰ tid å‚æ•°";
          return;
        }
        localStorage.setItem(LAST_TID_KEY, tid);
        localStorage.setItem(TRACKER_KEY, tid);
        refreshLastTid();
        document.getElementById("result").innerHTML = "âœ… å·²ä¿å­˜ last_tid: " + tid;
      }

      function clearLastTid() {
        localStorage.removeItem(LAST_TID_KEY);
        refreshLastTid();
        document.getElementById("result").innerHTML = "ğŸ—‘ï¸ å·²æ¸…é™¤ last_tid";
      }

      function writeId() {
        const id = "user_" + Date.now();
        localStorage.setItem(TRACKER_KEY, id);
        document.getElementById("result").innerHTML = "âœ… å†™å…¥: " + id;
      }

      function readId() {
        const id = localStorage.getItem(TRACKER_KEY);
        if (id) {
          document.getElementById("result").innerHTML =
            "ğŸ¯ è¯»åˆ°äº† tracker_id: " + id + "<br>ï¼ˆè¿™æ˜¯ç½‘ç«™Bæœ¬åŸŸä¿å­˜çš„å½’å› /è¿½è¸ªIDï¼‰";
        } else {
          document.getElementById("result").innerHTML =
            "âŒ æ²¡è¯»åˆ° tracker_id<br>è¯´æ˜å½“å‰ B åŸŸè¿˜æ²¡è½åº“å½’å› ID";
        }
      }

      function clearId() {
        localStorage.removeItem(TRACKER_KEY);
        document.getElementById("result").innerHTML = "ğŸ—‘ï¸ å·²æ¸…é™¤ tracker_idï¼ˆæœ¬åŸŸï¼‰";
      }
    </script>
  </body>
</html>
