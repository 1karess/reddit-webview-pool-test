# Reddit WebView Pool 源代码证据分析

## 关键代码证据

### 1. WebView Pool 回收逻辑（不清理存储）

**文件**: `sources/com/reddit/devplatform/composables/blocks/beta/block/webview/ui/DevPlatformWebViewKt$WebViewContent$3$1.java`

**关键代码**（第 69-80 行）：
```java
p02.setWebViewClient(new WebViewClient());
((LinkedList) z11.f172823f).addFirst(p02);
while (true) {
    int size = ((LinkedList) z11.f172823f).size();
    // ... 检查 Pool 大小 ...
    if (size <= (num != null ? num.intValue() : 7)) {
        break;
    } else {
        kotlin.collections.u.O((LinkedList) z11.f172823f);
    }
}
```

**证据**：
- ✅ 只重置了 `WebViewClient`
- ✅ 只把 WebView 放回 Pool（`addFirst`）
- ⚠️ 第 46 行：有条件调用 `clearHistory()`（但只在 `f79140r` 为 true 时）
- ❌ **`clearHistory()` 只清空浏览历史，不清空 localStorage/sessionStorage/Cookie**
- ❌ **没有调用 `clearCache()`、`deleteAllData()`、`removeAllCookies()` 等**

---

### 2. WebView setup() 方法（也不清理存储）

**文件**: `sources/com/reddit/devplatform/features/customposts/webview/l.java`

**关键代码**（第 109-124 行）：
```java
public final void setup(String bridgeContext) {
    kotlin.jvm.internal.f.g(bridgeContext, "bridgeContext");
    removeJavascriptInterface("__DEVVIT__");
    if (!kotlin.jvm.internal.f.b(getUrl(), "about:blank")) {
        loadUrl("about:blank");
    }
    this.f79104a.b();
    addJavascriptInterface(this.f79110g, "__DEVVIT__");
    setOnTouchListener(this);
    // ... 加载 URL ...
}
```

**证据**：
- ✅ 移除了旧的 JavaScript bridge
- ✅ 加载了 `about:blank`（清空页面内容）
- ❌ **没有清理 localStorage/sessionStorage**
- ❌ **没有清理 Cookie**
- ❌ **没有调用任何存储清理 API**

**注意**：`loadUrl("about:blank")` 只是清空页面内容，**不会清空 WebView 的存储**。

---

### 3. DOM Storage 已启用

**文件**: `sources/com/reddit/devplatform/features/customposts/webview/l.java`

**关键代码**（第 62 行）：
```java
getSettings().setDomStorageEnabled(true);
```

**证据**：
- ✅ Reddit **启用了 DOM Storage**（localStorage/sessionStorage）
- ✅ 这意味着 WebView **可以**使用 localStorage/sessionStorage
- ⚠️ 但代码中**没有清理这些存储的逻辑**

---

### 4. 使用 window.name 传递数据

**文件**: `sources/com/reddit/devplatform/features/customposts/webview/l.java`

**关键代码**（第 123 行）：
```java
loadDataWithBaseURL(null, kotlin.text.q.q("\n          <html>\n          <body>\n          <script>\n              window.name = " + JSONObject.quote(bridgeContext) + ";\n              window.location.replace(\"" + this.f79105b.f79123a + "\");\n          </script>\n          </body>\n          </html>\n      "), "text/html", "UTF-8", null);
```

**证据**：
- ✅ Reddit 使用 `window.name` 传递 `bridgeContext`
- ⚠️ `window.name` 在 WebView 中**会持久化**（即使页面关闭）
- ⚠️ 如果 `bridgeContext` 包含用户相关信息，可能跨账号残留

---

### 5. JavaScript 注入代码（不涉及存储操作）

**文件**: `sources/com/reddit/devplatform/features/customposts/webview/DevPlatformWebView$javaScriptInjectUpdateStateMessageInWebView$1.java`

**关键代码**（第 39 行）：
```java
this.this$0.evaluateJavascript(this.$stateJson, null);
```

**证据**：
- ✅ 只是注入状态更新消息
- ❌ **没有操作 localStorage/sessionStorage/Cookie 的代码**

---

## 搜索所有存储相关操作

### 搜索结果

在整个 `sources/com/reddit/devplatform` 目录中搜索：
- `localStorage` - **未找到**
- `sessionStorage` - **未找到**
- `setItem` / `getItem` - **未找到**
- `CookieManager.removeAllCookies` - **未找到**
- `WebStorage.deleteAllData` - **未找到**
- `clearCache` - **未找到**（在 WebView Pool 相关代码中）

---

## 结论

### 证据 1：WebView Pool 不清理存储 ✅

**代码位置**: `DevPlatformWebViewKt$WebViewContent$3$1.java:43-70`

**证据**：
- 第 46 行：有条件调用 `clearHistory()`（只在 `f79140r` 为 true 时）
- **重要**：`clearHistory()` **只清空浏览历史**，**不清空 localStorage/sessionStorage/Cookie**
- WebView 回收时（第 69-70 行）只重置 `WebViewClient`，把 WebView 放回 Pool
- **没有任何清理存储的代码**（`deleteAllData()`、`removeAllCookies()` 等）

### 证据 2：setup() 方法也不清理存储 ✅

**代码位置**: `l.java:109-124`

**证据**：
- `setup()` 只加载 `about:blank`（清空页面内容）
- 没有清理 localStorage/sessionStorage/Cookie

### 证据 3：Reddit 代码中没有操作 localStorage 的代码 ✅

**搜索结果**：
- 在整个 DevPlatform 相关代码中，**没有找到任何操作 localStorage/sessionStorage 的代码**
- 没有找到任何清理存储的代码

### 证据 4：DOM Storage 已启用 ⚠️

**代码位置**: `l.java:62`

**证据**：
- `setDomStorageEnabled(true)` - 启用了 DOM Storage
- 这意味着**可以**使用 localStorage/sessionStorage
- 但 Reddit **自己的代码没有使用**（至少在这个代码库中没找到）

---

## 最终结论

### 1. WebView Pool 确实不清理存储 ✅

**证据确凿**：代码中没有任何清理逻辑

### 2. Reddit 自己的代码没有在 WebView 存储中存数据 ✅

**证据确凿**：搜索整个代码库，没有找到任何操作 localStorage/sessionStorage 的代码

### 3. 但是存储功能是开启的 ⚠️

**证据确凿**：`setDomStorageEnabled(true)` 启用了存储功能

### 4. window.name 可能包含用户数据 ⚠️

**证据确凿**：`bridgeContext` 通过 `window.name` 传递，可能包含用户相关信息

---

## 风险评估

### 实际风险：低（目前）

**原因**：
- Reddit 自己的代码没有在 WebView 存储中存敏感数据
- 但存储功能是开启的，第三方代码（DevPlatform 页面）可能使用

### 潜在风险：中

**原因**：
- WebView Pool 不清理存储
- 如果未来 Reddit 或第三方代码把敏感数据放进 localStorage
- 会导致跨账号泄露

### 设计缺陷：确认

**证据**：
- WebView Pool 回收时没有清理存储
- 这是一个明显的设计缺陷，需要修复

---

## 报告建议

### 标题
**"WebView Pool 缺少账号级存储清理机制（设计缺陷）"**

### 内容
1. ✅ **证据 1**：WebView Pool 回收代码不清理存储（代码位置）
2. ✅ **证据 2**：setup() 方法也不清理存储（代码位置）
3. ✅ **证据 3**：Reddit 代码中没有操作存储的代码（搜索证据）
4. ⚠️ **证据 4**：DOM Storage 已启用，但未清理（潜在风险）
5. ⚠️ **证据 5**：window.name 可能包含用户数据（潜在风险）

### 结论
- 这是一个**设计缺陷**，不是**实际漏洞**
- 需要修复以防止未来出现问题
- 建议在 WebView Pool 回收时清理存储
